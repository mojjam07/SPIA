{% extends "base.html" %}

{% block content %}
<h2>Payment</h2>

{% if messages %}
<ul class="messages">
  {% for message in messages %}
  <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
  {% endfor %}
</ul>
{% endif %}

<form action="{% url 'payment' %}" method="post" id="payment-form" class="card p-4 bg-white rounded shadow-sm" style="max-width: 400px; margin: auto;">
  {% csrf_token %}
  
  <div class="mb-3">
    <label class="form-label"><strong>Select Subscription Plan:</strong></label><br>
    <div class="form-check">
      <input class="form-check-input" type="radio" id="one_month" name="subscription_plan" value="1_month" {% if subscription_plan == '1_month' %}checked{% endif %} required>
      <label class="form-check-label" for="one_month">1 Month - ₦5,000</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="radio" id="six_month" name="subscription_plan" value="6_month" {% if subscription_plan == '6_month' %}checked{% endif %}>
      <label class="form-check-label" for="six_month">6 Months - ₦27,000</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="radio" id="one_year" name="subscription_plan" value="1_year" {% if subscription_plan == '1_year' %}checked{% endif %}>
      <label class="form-check-label" for="one_year">1 Year - ₦50,000</label>
    </div>
  </div>
  
  <div id="card-element" class="mb-3"><!-- Stripe.js injects the Card Element --></div>
  <div id="card-errors" role="alert" style="color: red;" class="mb-3"></div>
  <button type="submit" class="btn btn-primary w-100">Pay</button>
</form>

<script src="https://js.stripe.com/v3/"></script>
<script>
  var stripe = Stripe('{{ stripe_public_key }}');
  var elements = stripe.elements();
  var style = {
    base: {
      color: "#32325d",
      fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
      fontSmoothing: "antialiased",
      fontSize: "16px",
      "::placeholder": {
        color: "#aab7c4"
      }
    },
    invalid: {
      color: "#fa755a",
      iconColor: "#fa755a"
    }
  };
  var card = elements.create("card", { style: style });
  card.mount("#card-element");

  card.on('change', function(event) {
    var displayError = document.getElementById('card-errors');
    if (event.error) {
      displayError.textContent = event.error.message;
    } else {
      displayError.textContent = '';
    }
  });

  var form = document.getElementById('payment-form');
  form.addEventListener('submit', function(event) {
    event.preventDefault();

    stripe.createToken(card).then(function(result) {
      if (result.error) {
        var errorElement = document.getElementById('card-errors');
        errorElement.textContent = result.error.message;
      } else {
        stripeTokenHandler(result.token);
      }
    });
  });

  function stripeTokenHandler(token) {
    var form = document.getElementById('payment-form');
    var hiddenInput = document.createElement('input');
    hiddenInput.setAttribute('type', 'hidden');
    hiddenInput.setAttribute('name', 'stripeToken');
    hiddenInput.setAttribute('value', token.id);
    form.appendChild(hiddenInput);

    form.submit();
  }
</script>
{% endblock %}
